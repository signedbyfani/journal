<!--
  This is a critical style block to prevent flashing on page load.
  It is injected into the <head> of the document before the main stylesheets are loaded.
-->
<style is:inline>
  :root {
    --bg: #ffffff;
  }

  html {
    background-color: var(--bg);
    color-scheme: light;
  }
</style>

<script is:inline>
  // Global Theme Manager
  ;(function () {
    // Prevent duplicate initialization
    if (window.ThemeManager && window.ThemeManager.initialized) {
      return
    }

    window.ThemeManager = {
      STORAGE_KEY: 'chiri-theme',
      initialized: false,

      getSystemTheme() {
        return 'light'
      },

      getStoredTheme() {
        try {
          return localStorage.getItem(this.STORAGE_KEY)
        } catch {
          return null
        }
      },

      setStoredTheme(theme) {
        try {
          if (theme === 'system') {
            localStorage.removeItem(this.STORAGE_KEY)
          } else {
            localStorage.setItem(this.STORAGE_KEY, theme)
          }
        } catch (e) {
          console.warn('Failed to store theme preference:', e)
        }
      },

      getEffectiveTheme() {
        return 'light'
      },

      isUsingSystemTheme() {
        return this.getStoredTheme() === null
      },

      applyTheme(theme) {
        document.documentElement.classList.remove('dark')
        document.documentElement.classList.add('light')

        // Dispatch event for other components
        document.dispatchEvent(
          new CustomEvent('themechange', {
            detail: {
              theme,
              isUserChoice: !this.isUsingSystemTheme(),
              isSystemTheme: this.isUsingSystemTheme()
            }
          })
        )
      },

      init() {
        if (this.initialized) return

        // Set initial theme
        this.applyTheme(this.getEffectiveTheme())

        this.initialized = true
      }
    }

    // Initialize theme manager
    window.ThemeManager.init()

    // Apply theme when needed
    const applyTheme = () => {
      if (window.ThemeManager) {
        const theme = window.ThemeManager.getEffectiveTheme()
        window.ThemeManager.applyTheme(theme)
      }
    }

    // Apply immediately on script load
    applyTheme()

    // Listen for navigation events
    document.addEventListener('astro:before-preparation', applyTheme)

    // Apply theme after DOM changes (both swap and page load)
    const applyThemeAfterNavigation = () => {
      if (window.ThemeManager) {
        const currentTheme = window.ThemeManager.getEffectiveTheme()
        const appliedTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'

        if (currentTheme !== appliedTheme) {
          // Use requestAnimationFrame to ensure theme is applied in the next frame, avoiding conflicts with view transition
          requestAnimationFrame(() => {
            window.ThemeManager.applyTheme(currentTheme)
          })
        }
      }
    }

    document.addEventListener('astro:after-swap', applyThemeAfterNavigation)
    document.addEventListener('astro:page-load', applyThemeAfterNavigation)

    // Handle system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (window.ThemeManager && window.ThemeManager.isUsingSystemTheme()) {
        setTimeout(applyTheme, 0)
      }
    })
  })()
</script>
